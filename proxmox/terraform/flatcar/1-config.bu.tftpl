version: 1.0.0
variant: flatcar
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIVSFwDNe6CRv1hqfQo+G3NzsNHoz2ndSfAUFBnbF4/0 eddsa-key-20250802
storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: "cf-pve-cl-01-flatcar-${vm_count_index + 1}"

    - path: /opt/bin/docker-compose
      contents:
        source: https://github.com/docker/compose/releases/download/v2.39.1/docker-compose-linux-x86_64
        verification:
          hash: sha256-a5ea28722d5da628b59226626f7d6c33c89a7ed19e39f750645925242044c9d2
      mode: 0755

    - path: /etc/systemd/network/static.network
      contents:
        inline: |
          [Match]
          Name=eth0
          [Network]
          Address=10.0.10.${221 + vm_count_index}/24
          Gateway=10.0.10.1
          DNS=10.0.10.127
          DNS=10.0.10.68

    - path: /etc/flatcar/update.conf
      overwrite: true
      contents:
        inline: |
          REBOOT_STRATEGY=reboot
          LOCKSMITHD_REBOOT_WINDOW_START=06:00
          LOCKSMITHD_REBOOT_WINDOW_LENGTH=1h          
      mode: 0420

    - path: /home/core/docker-compose.yaml
      contents:
        source: ${docker-compose-template}
      mode: 0644
      user:
        name: core
      group:
        name: core

systemd:
  units:


    - name: docker-compose.service
      enabled: true
      contents: |
        [Unit]
        Description=Minimalist docker-compose example
        After=docker.service
        Requires=docker.service
        [Service]
        ExecStart=/opt/bin/docker-compose -f /home/core/docker-compose.yaml up
        ExecStop=/opt/bin/docker-compose -f /home/core/docker-compose.yaml down
        Restart=always
        RestartSec=5
        [Install]
        WantedBy=multi-user.target


    - name: zabbix-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=Zabbix Agent Docker Container
        After=docker.service
        Requires=docker.service

        [Service]
        ExecStart=/usr/bin/docker run \
          --name zabbix-agent \
          --rm \
          --network host \
          --user 0:0 \
          -v /var/run/docker.sock:/var/run/docker.sock:ro \
          -e ZBX_HOSTNAME="cf-pve-cl-01-flatcar-${vm_count_index + 1}" \
          -e ZBX_SERVER_HOST="10.0.10.208" \
          zabbix/zabbix-agent2:latest
        ExecStop=/usr/bin/docker stop zabbix-agent
        Restart=always
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
